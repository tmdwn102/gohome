<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">

  <title> <마꾸> 마트료시카 꾸미기라는 뜻</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      height: 100vh;
      margin: 0;
      background-color: #f0f0f0;
      overflow: hidden;
    }
    .canvas-container {
      position: relative;
      width: 1000px;
      height: 560px;
      background-color: #ddd;
      margin-bottom: 20px;
      overflow: hidden;
      border: 1px;

    }
    .canvas-container img {
      position: absolute;
      pointer-events: none;
      transform: translate(-50%, -50%);
    }
    .container {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      max-width: 600px;

    }
    .link {
      width: 100px;
      height: 100px;
      background-color: #fff;
      border: 1px solid #6f6f6f;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    .link:hover {
      transform: scale(1.1);
    }
    .link img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
    .cursor-image {
      position: absolute;
      pointer-events: none;
      opacity: 0.6;
      display: none;
      z-index: 1000;
    }
    .next-button, .prev-button {
      position: absolute;
      top : 30px;
      bottom: 30px;
      padding: 10px 20px;
      border: none;
      font-size: 1em;
      cursor: pointer;

    }
    .next-button {
      right: 0px;
      background-color: #4CAF50;
      color: white;
    }
    .next-button:hover {
      background-color: #3e8e41;
    }
    .prev-button {
      left: 0px;
      background-color: #4CAF50;
      color: white;
    }
    .prev-button:hover {
      background-color: #3e8e41;
    }
    #final-image {
      margin-top: 10px;
      max-width: 100%;
    }
  </style>
</head>
<body>
  <div class="canvas-container" id="canvas"></div> <!-- 캔버스 -->
  <div class="container" id="content">
    <!-- 첫 단계 선택박스 -->
    <div class="link" onclick="selectFirstImage('1a.png')"><img src="1a.png" alt="1A"></div>
    <div class="link" onclick="selectFirstImage('1b.png')"><img src="1b.png" alt="1B"></div>
    <div class="link" onclick="selectFirstImage('1c.png')"><img src="1c.png" alt="1C"></div>
  </div>
  <img id="cursorImage" class="cursor-image" src="" alt="Cursor Image">
  <button class="next-button" onclick="nextStep()" style="display: none;">다음으로</button>
  <button class="prev-button" onclick="removeLastImage()" style="display: none;">되돌아가기</button>
  <img id="final-image" style="display: none;"> <!-- 캡쳐된 최종 이미지가 이곳에 표시됨 -->

  <script>
    const canvas = document.getElementById("canvas");
    const cursorImage = document.getElementById("cursorImage");
    const content = document.getElementById("content");
    const finalImage = document.getElementById("final-image");
    let currentStep = 1;
    let imagesOnCanvas = 0;
    const maxImages = 10;
    let currentZIndex = 500;
    let addedImages = [];

    // 첫 번째 단계에서 이미지 선택
    function selectFirstImage(imagePath) {
      // 첫 번째 단계에서 선택한 이미지를 바로 캔버스에 추가
      const img = document.createElement("img");
      img.src = imagePath;
      img.style.left = "50%";
      img.style.top = "50%";

      img.style.zIndex = currentStep === 8 ? 1 : 2;
      canvas.innerHTML = ""; // 이전 이미지 제거
      canvas.appendChild(img);
      addedImages.push(img); // 추가된 이미지 저장
      setTimeout(() => nextStep(), 500);
    }

    // 다음 단계로 이동
    function nextStep() {
      if (currentStep >= 8) {
        captureCanvas();
        return;
      }

      currentStep++;
      imagesOnCanvas = 0;
      // 캔버스를 리셋 안하기
      if (currentStep === 8) {
        content.style.zIndex = 1;
      } else {
        content.style.zIndex = currentZIndex++;
      }

      const selectionCounts = { 2: 5, 3: 5, 4: 5, 5: 5, 6: 10, 7: 10, 8: 5};
      const selections = selectionCounts[currentStep] || 3;

      // 선택박스 업데이트
      content.innerHTML = "";
      for (let i = 1; i <= selections; i++) {
        const link = document.createElement("div");
        link.className = "link";
        const img = document.createElement("img");
        img.src = `${currentStep}${String.fromCharCode(96 + i)}.png`;
        img.alt = `${currentStep}${String.fromCharCode(96 + i).toUpperCase()}`;
        link.appendChild(img);

        link.onclick = () => startDragging(`${currentStep}${String.fromCharCode(96 + i)}.png`);
        content.appendChild(link);
      }

      if (currentStep > 1) {
        document.querySelector(".next-button").style.display = "block";
      }
      document.querySelector(".prev-button").style.display = "block";
    }

    // 드래그
    function startDragging(imagePath) {
      if (imagesOnCanvas >= maxImages) {
        alert("단계별로 최대 10개의 이미지만 올릴 수 있습니다");
        return;
      }
      cursorImage.src = imagePath;
      cursorImage.style.display = "block";

      document.addEventListener("mousemove", followCursor);
      canvas.addEventListener("click", placeImage);
    }

    // 마우스 따라다니기
    function followCursor(event) {
      const cursorSize = 150;
      cursorImage.style.width = `${cursorSize}px`;
      cursorImage.style.height = `${cursorSize * (cursorImage.naturalHeight / cursorImage.naturalWidth)}px`; // 원본 비율 유지
      cursorImage.style.left = `${event.pageX - cursorSize / 2}px`;
      cursorImage.style.top = `${event.pageY - cursorSize / 2 + 50}px`;
    }

    function placeImage(event) {
      const rect = canvas.getBoundingClientRect();
      const x = event.clientX - rect.left;
      const y = event.clientY - rect.top;

      const img = document.createElement("img");
      img.src = cursorImage.src;
      img.style.left = `${x}px`;
      img.style.top = `${y}px`;

      if (currentStep === 8) {
        img.style.zIndex = 1; // 8단계 이미지는 가장 아래
      } else {
        img.style.zIndex = currentStep + 2; // 1단계 이후부터 점진적으로 증가
      }
      img.style.width = `${150}px`;
      img.style.height = `${150 * (cursorImage.naturalHeight / cursorImage.naturalWidth)}px`; // 원본 비율 유지
      canvas.appendChild(img);

      addedImages.push(img); // 이미지 배열에 추가
      imagesOnCanvas++;
      cursorImage.style.display = "none";
      document.removeEventListener("mousemove", followCursor);
      canvas.removeEventListener("click", placeImage);
    }

    // 직전에 추가된 이미지 삭제
    function removeLastImage() {
      if (addedImages.length > 0) {
        const lastImage = addedImages.pop(); // 마지막 이미지 제거
        canvas.removeChild(lastImage);
        imagesOnCanvas--;
      }
    }

    
    // 7단계에서 캔버스를 캡쳐하고 이미지로 보여주는 함수
    function captureCanvas() {
      document.querySelector(".next-button").disabled = true; // 캡처 중에는 "다음으로" 버튼 비활성화
      html2canvas(canvas).then((canvasSnapshot) => {
        finalImage.src = canvasSnapshot.toDataURL();
        finalImage.style.display = "block"; // 캡처된 이미지 보이기
        document.querySelector(".next-button").style.display = "none";
        document.querySelector(".prev-button").style.display = "none";
        document.querySelector(".next-button").disabled = false; //캡쳐완료되면 다음으로 버튼 활성화
      });
    }
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.4.1/html2canvas.min.js"></script>
</body>
</html>
