<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">

  <title> <트꾸> 트리 꾸미기</title>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      height: 100vh;
      margin: 0;
      background-color: #f0f0f0;
      overflow: hidden;
    }
    .canvas-container {
      position: relative;
      width: 500px;
      height: 560px;
      background-color: #ddd;
      margin-bottom: 20px;
      overflow: hidden;
      border: 1px;

    }
    .canvas-container img {
      position: absolute;
      pointer-events: none;
      transform: translate(-50%, -50%);
    }
    .container {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      max-width: 600px;
    }
    .link {
      width: 100px;
      height: 100px;
      background-color: #fff;
      border: 1px solid #6f6f6f;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    .link:hover {
      transform: scale(1.1);
    }
    .link img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
    .cursor-image {
      position: absolute;
      pointer-events: none;
      opacity: 0.6;
      display: none;
      z-index: 1000;
    }
    .next-button, .prev-button {
      position: absolute;
      top : 30px;
      bottom: 30px;
      padding: 10px 20px;
      border: none;
      font-size: 1em;
      cursor: pointer;
      width: 150px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;

    }
    .next-button {
      right: 340px;
      background-color: #ffffff;
      color: rgb(0, 0, 0);
    }
    .next-button:hover {
      background-color: #d6d6d6;
    }
    .prev-button {
      position: absolute;
      left: 340px;
      height: 50px;
      background-color: #ffffff;
      color: rgb(0, 0, 0);
      font-size: 1em;
      cursor: pointer;
    }
    .prev-button:hover {
      background-color: #d6d6d6;
    }
    .download-button {
      left: 190px;
      width: 50px;
      height: 50px;
      padding: 0;
      font-size: 0;
      background: url('download.png') no-repeat center center;
      background-size: contain;
    }
    #final-image {
      margin-top: 10px;
      max-width: 100%;
    }
  </style>

</head>
<body>
  <div class="canvas-container" id="canvas"></div> <!-- 캔버스 -->
  <div class="container" id="content">
    <!-- 첫 단계 선택박스 -->
    <div class="link" onclick="selectFirstImage('1a.png')"><img src="1a.png" alt="1A"></div>
    <div class="link" onclick="selectFirstImage('1b.png')"><img src="1b.png" alt="1B"></div>
    <div class="link" onclick="selectFirstImage('1c.png')"><img src="1c.png" alt="1C"></div>
  </div>
  <img id="cursorImage" class="cursor-image" src="" alt="Cursor Image">
  <button class="next-button" onclick="nextStep()" style="display: none;">다음으로</button>
  <button class="prev-button" onclick="removeLastImage()" style="display: none;">되돌아가기</button>
  <button class="next-button" onclick="completeCanvas()" style="display: none;">완성</button>

  <img id="final-image" style="display: none;"> <!-- 캡쳐된 최종 이미지가 이곳에 표시됨 -->

  <script>
    const canvas = document.getElementById("canvas");
    const cursorImage = document.getElementById("cursorImage");
    const content = document.getElementById("content");
    const finalImage = document.getElementById("final-image");
    let currentStep = 1;
    let imagesOnCanvas = 0;
    const maxImages = 10;
    let currentZIndex = 500;
    let addedImages = [];

    // 첫 번째 단계에서 이미지 선택
    function selectFirstImage(imagePath) {
      const img = document.createElement("img");
      img.src = imagePath;
      img.style.left = "50%";
      img.style.top = "50%";

      img.style.zIndex = currentStep === 7 ? 1 : 2;
      canvas.innerHTML = ""; // 이전 이미지 제거
      canvas.appendChild(img);
      addedImages.push(img); // 추가된 이미지 저장
      setTimeout(() => nextStep(), 500);
    }

    function nextStep() {
      if (currentStep >= 7) {
        document.querySelector(".next-button[onclick='completeCanvas()']").style.display = "block"; // "완성" 버튼 보이기
        return;
      }

      currentStep++;
      imagesOnCanvas = 0;

      if (currentStep === 7) {
        content.style.zIndex = 1; // 마지막 단계 z-index 조정
      } else {
        content.style.zIndex = currentZIndex++;
      }

      const selectionCounts = { 2: 5, 3: 5, 4: 5, 5: 10, 6: 10, 7: 7 };
      const selections = selectionCounts[currentStep] || 3;

      content.innerHTML = "";
      for (let i = 1; i <= selections; i++) {
        const link = document.createElement("div");
        link.className = "link";
        const img = document.createElement("img");
        img.src = `${currentStep}${String.fromCharCode(96 + i)}.png`;
        img.alt = `${currentStep}${String.fromCharCode(96 + i).toUpperCase()}`;
        link.appendChild(img);

        link.onclick = () => startDragging(`${currentStep}${String.fromCharCode(96 + i)}.png`);
        content.appendChild(link);
      }

      if (currentStep > 1) {
        document.querySelector(".next-button").style.display = "block";
      }
      document.querySelector(".prev-button").style.display = "block";
    }

    // 드래그
    function startDragging(imagePath) {
      if (currentStep === 7) {
        placeCenteredImage(imagePath);
      } else {
          if (imagesOnCanvas >= maxImages) {
              alert("단계별로 최대 10개의 이미지만 올릴 수 있습니다");
              return;
          }
          cursorImage.src = imagePath;
          cursorImage.style.display = "block";

          document.addEventListener("mousemove", followCursor);
          canvas.addEventListener("click", placeImage);
      }
    }

    let step8Images = [];

    function placeCenteredImage(imagePath) {
    if (currentStep === 7) {
        step8Images.forEach(image => canvas.removeChild(image));
        step8Images = [];
    }

    // 새 이미지를 중앙에 추가
    const img = document.createElement("img");
    img.src = imagePath;
    img.style.position = "absolute";
    img.style.left = "50%";
    img.style.top = "50%";
    img.style.transform = "translate(-50%, -50%)";

    // 캔버스 크기나 이미지 원본 크기를 기준으로 크기 설정
    const canvasWidth = canvas.offsetWidth;
    const canvasHeight = canvas.offsetHeight;

    // 이미지의 원본 크기 계산
    const imgAspectRatio = img.naturalWidth / img.naturalHeight;

    // 캔버스 크기에 맞춰 이미지 크기 조정
    if (imgAspectRatio > 1) {  // 가로가 긴 경우
        img.style.width = `${canvasWidth}px`;  // 캔버스의 90% 너비
        img.style.height = 'auto';  // 자동 높이 계산
    } else {  // 세로가 긴 경우
        img.style.height = `${canvasHeight}px`;  // 캔버스의 90% 높이
        img.style.width = 'auto';  // 자동 너비 계산
    }

    img.style.zIndex = 1;

    canvas.appendChild(img);

    if (currentStep === 7) {
        step8Images.push(img);
    } else {
        addedImages.push(img); // 다른 단계는 기존 배열 사용
    }
}



    // 마우스 따라다니기
    function followCursor(event) {
      const cursorSize = 150;
      cursorImage.style.width = `${cursorSize}px`;
      cursorImage.style.height = `${cursorSize * (cursorImage.naturalHeight / cursorImage.naturalWidth)}px`; // 원본 비율 유지
      cursorImage.style.left = `${event.pageX - cursorSize / 2}px`;
      cursorImage.style.top = `${event.pageY - cursorSize / 2 + 50}px`;
    }

    function placeImage(event) {
      const rect = canvas.getBoundingClientRect();
      const x = event.clientX - rect.left;
      const y = event.clientY - rect.top;

      const img = document.createElement("img");
      img.src = cursorImage.src;


      if (currentStep === 7) {
        img.style.zIndex = 1; // 8단계 이미지는 가장 아래
        img.style.height = `${canvas.offsetHeight}px`; // 캔버스 높이에 맞춤
        img.style.width = `${canvas.offsetHeight * (cursorImage.naturalWidth / cursorImage.naturalHeight)}px`; // 비율 유지
        img.style.left = `${(canvas.offsetWidth - img.offsetWidth) / 2}px`; // 가로 중앙 정렬
        img.style.top = `0px`; // 위쪽 기준
    } else {
        img.style.zIndex = currentStep + 2; // 1단계 이후부터 점진적으로 증가
        img.style.left = `${x}px`;
        img.style.top = `${y}px`;
        img.style.width = `${150}px`;
        img.style.height = `${150 * (cursorImage.naturalHeight / cursorImage.naturalWidth)}px`; // 원본 비율 유지
    }
    
      canvas.appendChild(img);
      addedImages.push(img); // 이미지 배열에 추가
      imagesOnCanvas++;
      cursorImage.style.display = "none";
      document.removeEventListener("mousemove", followCursor);
      canvas.removeEventListener("click", placeImage);
    }

    // 직전에 추가된 이미지 삭제
    function removeLastImage() {
      if (addedImages.length > 0) {
        const lastImage = addedImages.pop(); // 마지막 이미지 제거
        canvas.removeChild(lastImage);
        imagesOnCanvas--;
      }
    }

    
// 완성 클릭 시 화면 캡쳐
function completeCanvas() {
  //선택 버튼 숨기기
  document.getElementById("content").style.display = "none";

  captureCanvas();
  function captureCanvas() {
  const canvasSnapshotArea = document.querySelector(".canvas-container");

  html2canvas(canvasSnapshotArea).then((canvasSnapshot) => {
    const dataURL = canvasSnapshot.toDataURL();
    finalImage.src = dataURL;
    finalImage.style.display = "block";

    const downloadButton = document.createElement("button");
    downloadButton.className = "download-button";
    downloadButton.onclick = () => {
      const link = document.createElement('a');
      link.download = 'tree-decoration.png';
      link.href = dataURL;
      link.click();
    };
    document.body.appendChild(downloadButton); //다운로드 버튼 추가
  });
}

}

</script>


</body>
</html>
